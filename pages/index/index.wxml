<!-- index.wxml -->
<navigation-bar
  title="点点长知识"
  back="{{false}}"
  color="black"
  background="#FFF"
/>

<view class="page-body">
  <!-- 地图 -->
  <map
    class="map"
    id="map"
    longitude="{{center.longitude}}"
    latitude="{{center.latitude}}"
    scale="{{scale}}"
    bindtap="onMapTap"
    bindpoitap="onPoiTap"
    show-location="true"
  />

  <!-- 底部弹窗 (非阻塞式) -->
  <view class="bottom-sheet {{bottomSheetVisible ? 'bottom-sheet--show' : ''}}">
    <!-- 顶部把手 -->
    <view class="bottom-sheet__header" bindtap="onCloseBottomSheet"></view>

    <scroll-view class="bottom-sheet-content" scroll-y="true">
      <view class="info-title">{{selectedLocation.name}}</view>
      
      <!-- 元信息：省份、经纬度 -->
      <view class="info-meta">
        <view class="info-meta-item" wx:if="{{selectedLocation.province}}">{{selectedLocation.province}}</view>
        <view class="info-meta-item">东经 {{selectedLocation.longitude}}</view>
        <view class="info-meta-item">北纬 {{selectedLocation.latitude}}</view>
      </view>
      
      <!-- 匹配到的知识 (精准匹配) -->
      <view 
        wx:if="{{matchedKnowledge}}"
        class="knowledge-item matched" 
        bindtap="onArticleTap" 
        data-url="{{matchedKnowledge.url}}" 
        data-title="{{matchedKnowledge.title}}"
      >
        <view class="knowledge-title">{{matchedKnowledge.title}}</view>
        <view class="icon-arrow-right"></view>
      </view>

      <!-- 知识库 -->
      <view class="knowledge-card {{knowledgeBaseExpanded ? 'knowledge-card--expanded' : ''}}" wx:if="{{allKnowledge.length > 0}}">
        <view class="section-header" bindtap="toggleKnowledgeBase">
          <view class="section-title">知识库</view>
          <view class="icon-arrow-{{knowledgeBaseExpanded ? 'down' : 'right'}}"></view>
        </view>
        
        <view wx:if="{{knowledgeBaseExpanded}}" class="knowledge-list">
          <view 
            wx:for="{{allKnowledge}}" 
            wx:key="title" 
            class="knowledge-item" 
            bindtap="onArticleTap" 
            data-url="{{item.url}}" 
            data-title="{{item.title}}"
          >
            <view class="knowledge-title">{{item.title}}</view>
            <view class="icon-arrow-right"></view>
          </view>
        </view>
      </view>

      <!-- 城市推荐 -->
      <block wx:if="{{cityImages.length > 0}}">
        <view class="section-header">
          <view class="section-title">{{selectedLocation.city}}推荐</view>
        </view>
        <view class="image-waterfall">
          <view class="waterfall-item" wx:for="{{cityImages}}" wx:key="*this">
            <image
              class="waterfall-image"
              src="{{item}}"
              mode="aspectFill"
              data-index="{{index}}"
              data-type="city"
              bindtap="onImagePreview"
            />
          </view>
        </view>
      </block>

      <!-- 省份推荐 -->
      <block wx:if="{{provinceImages.length > 0}}">
        <view class="section-header">
          <view class="section-title">{{selectedLocation.province}}推荐</view>
        </view>
        <view class="image-waterfall">
          <view class="waterfall-item" wx:for="{{provinceImages}}" wx:key="*this">
            <image
              class="waterfall-image"
              src="{{item}}"
              mode="aspectFill"
              data-index="{{index}}"
              data-type="province"
              bindtap="onImagePreview"
            />
          </view>
        </view>
      </block>
      
      <!-- 底部留白 -->
      <view style="height: 10rpx;"></view>
    </scroll-view>
  </view>
</view>
